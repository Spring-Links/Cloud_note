**LVS：** 使用负载均衡技术将多台服务器组成一个虚拟服务器
- **基本原理：** 
  - 客户端向负载均衡调度器ds发起请求，调度器将请求发往内核空间
  - prerouting首先收到请求后判断目标ip是否为本机ip，如果是就将数据包发给input链
  - ipvs工作在input链上，当数据包到达input链时，ipvs将对请求与自己的集群服务进行对比，如果是自己的集群服务就修改数据包里的目标ip及端口，并将数据包发给postrouting链
  - postrouting链接受数据包后发现目标ip时自己的后端服务器，就通过选路将数据包发给后端服务器
- **LVS组成**
  - **ipvs：** 工作在内核空间，是真正实现调度的部分，由ip包处理、负载均衡算法、系统配置与管理这三个模块以及虚拟服务器与真实服务器链表组成
  - **ipvsadm：** 工作在用户空间，即ipvs管理器，负责为ipvs内核编写规则，定义谁是集群服务谁是后端真实的服务器

**技术术语**
- **DS（Director Server）：** 前端负载均衡节点
- **RS（Real Server）：** 后端真实服务器
- **VIP（Virtual IP）：** 向外部直接面向用户请求，作为用户请求的目标ip
- **DIP（Director Server IP）：** 用于和内部主机通讯的ip
- **RIP（Real Server IP）：** 后端服务器ip
- **CIP（Client IP）：** 客户端ip

**LVS工作模式和原理**
- **NAT模式**
    - **原理：** 
      - 当客户端的请求到达DS也就是负载均衡节点时，请求的报文会先进入内核空间的prerouting链。此时报文的源ip为cip，目标ip为vip
      - 此时prerouting链检查数据包发现目标ip时本机便将数据包发给input链
      - ipvs工作在input链上负责负载均衡的部分会判断请求的服务是否为集群服务，如果是它就会将数据包的目标ip修改为后端的真实ip，然后再将数据包发给postrouting链。此时报文的源ip为cip，目标ip为rip
      - postrouting链通过选路将数据包发给rs
      - rs发现目标ip是自己的就会构建响应报文发回ds。此时源ip为rip，目标ip为cip
      - ds再响应客户端之前将源ip改为自己的ip也就是vip，然后响应客户端。此时原ip为vip,目标ip为cip
    - **特性：**
      - rip最好是内网ip
      - rs的网关必须指向dip
      - dip和rip必须再同一个网段中
      - 请求和回应的报文必须经过ds，ds容易称为瓶颈
      - nat支持端口转发

- **DR模式**
  - **原理：** 
    - 首先客户端使用cip请求vip
    - 当请求到达ds时，报文先进入prerouting链。此时报文的源ip为cip，目标ip为vip
    - prerouting链检查发现目标ip是本机，就将数据包发给input链
    - ipvs工作在input链上，它对比发现数据包请求的是集群服务就将报文的源mac地址改为dip的mac地址，将目标mac地址修改为rip的mac地址，然后数据包发给postrouting链，。此时源ip与目标ip均未被修改，仅修改了源mac地址为dip的mac地址，目标mac地址为rip的mac地址
    - 由于ds和rs在同一个网络下，所以通过二层来传输。postrouting链检查发现目标mac地址为rip的mac地址就将数据包发给rs
    - rs发现报文的mac地址是自己的mac地址，就接收该报文。处理完成以后就将响应报文通过lo接口传给eth0网卡然后向外发出。此时源ip为vip，目标ip为cip
    - 报文最终到达客户端
  - **配置DR**
    - **第一种：** 
      - 修改内核参数（kernelparameter）
      - 第一个是`arp_ignore`，它定义接受arp请求时的级别
        - 0：只要本地配置的有相应地址就响应（默认）
        - 1：仅回应目标ip地址是本地的入网地址的arp请求
        - 2：仅回应目标ip地址是本地的入网地址，而且源ip和目标ip在同一个子网的arp请求
        - 3：不回应网络界面的arp请求，而只对设置的唯一和连接地址做出回应
        - 4-7：保留未使用
        - 8：不回应所有的arp请求
      - 第二个是`arp_announce`，它定义将自己地址向外通告时的通告级别
        - 0：将本地任何接口上的任何地址向外通告
        - 1：仅向目标网络通告与其网络匹配的地址
        - 2：仅向与本地接口上地址匹配的网络进行通告
    - **第二种：** 
        > 在路由器上明显说明vip对应的地址一定是Director上的MAC，只要绑定，以后再跟vip通信也不用再请求了，这个绑定是静态的，所以它也不会失效，也不会再次发起请求，但是有个前提，我们的路由设备必须有操作权限能够绑定MAC地址，万一这个路由器是运行商操作的，我们没法操作怎么办？第一种方式固然很简便，但未必可行。
    - **第三种：** 
        > 在给别主机上（例如：红帽）它们引进的有一种程序arptables,它有点类似于iptables,它肯定是基于arp或基于MAC做访问控制的，很显然我们只需要在每一个real server上定义arptables规则，如果用户arp广播请求的目标地址是本机的vip则不予相应，或者说相应的报文不让出去，很显然网关（gateway）是接受不到的，也就是director相应的报文才能到达gateway，这个也行。第二种方式我们可以基于arptables。
  - **特性：** 
    - 保证前端路由将目标地址为vip报文统统发给ds而不是rs
    - ds和rs的vip为同一个vip
    - rs可以使用私有地址也可以使用公网地址，如果使用公网地址此时可以通过互联网对rip进行直接访问
    - ds和rs必须在同一个物理网络中
    - 所有请求报文经过ds，但是响应报文不能经过ds
    - 不支持地址转换、端口映射
    - rs的网关绝对不允许指向dip，因为我们不允许它经过ds
    - 在rs的lo接口上配置vip的ip地址
    - dr模式在市面上使用最广
    - 缺点：rs与ds必须在同一个机房

- **Tunnel模式**
  - **原理**
    - 当请求到达ds时进入prerouting链，此时源ip为cip，目标ip为vip
    - prerouting链发现请求的目标ip是本机，就将请求发给input链
    - ipvs工作在input链上，它发现报文请求的是自己的集群，在请求报文的首部再次封装一层ip报文，封装源ip为dip，目标ip为rip。然后发往postrouting链，此时源ip为dip，目标ip为rip
    - postrouting链发现目标ip为rip就将报文发给rs（因为最外层封装了一层ip首部，可以理解为此时通过隧道传输），此时源ip为dip，目标ip为rip
    - rs发现报文的目标ip为rip就接受报文，拆除最外层ip后发现还有一层ip首部，其中目标是自己的lo接口的vip，此时rs开始处理这份请求，构建的响应报文通过lo接口进入eth0网卡向外部传递，此时源ip为vip，目标ip为cip
    - 响应报文最终到达客户端
  - **特性**
    - vip、rip、dip全是公网地址
    - rs的网关不会也不可能指向dip
    - 所有请求报文经过rs，所有响应报文不能经过ds
    - 不支持端口映射
    - rs的系统必须支持隧道


**调度算法**
- **固定调度**
  - **rr（轮询）：** 按照依次循环的方式将请求调度到不同服务器上，不管后端rs的配置和处理能力。如果服务器A上的请求很快处理完了，但B服务器的请求一直持续将导致B服务器一直忙，使左右不均衡
  - **wrr（加权轮询）：** 相较于轮询增加了权重的概念，可以给rs设置权重，取值为0-100
  - **dh（目标地址散列调度）：** 将同一类型的请求分配到同一个后端服务器，例如将.jpg或.png结尾的请求转发到同一节点上，将资源进行分类管理，主要应用于缓存节点系统中，提高缓存命中率
  - **sh（源地址散列调度）：** 当后端服务器工作没有超负荷时，将来自同一个ip的请求发送给后端的同一个服务器（能解决session共享问题），但企业、学校和社区一般共用同一个ip，所以会导致分配不均衡
- **动态调度**
  - **lc（最少连接数）：** 根据后端rs的连接数来决定请求方法情况，哪个rs连接数少就给哪个rs，但不能保持会话
  - **wlc（加权最少连接数）：** 在lc算法情况下加入权重，当连接数近似时，根据权重分配请求
  - **lblc（基于局部性的最少连接调度）：** 将来自同一目的地址的请求分配给同一台rs中（当这个rs未满负荷），负责分配给连接数最少的rs，并以它作为下一次分配的首要考虑
  - **lblcr（基于地址的带重复最小连接数调度）：** 略过
